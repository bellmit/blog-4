
11.13
a)	学到了拆分订单是OFC的逻辑；弄懂998配置，主要配置了各个配送中心的支援关系、平行库存支援关系、以及厂直覆盖范围。
b)	学到了自营商品共用一套仓覆盖逻辑，对应1902-1909配置，也可以用大禹平台来查找（可以找某个仓覆盖的配送中心，也可以找某个地址被哪些仓覆盖）。
c)	pop商品可以商家自己配置优先级，“11“开头的为京仓，并且mark为32代表京配（mark为0，代表可京配也可不京配，需要按照优先级）；”0“号仓为商家仓。

本地仓的概念是在**1号配置（1902-1909配置）**中配置了覆盖范围

11.20
1.1	弄懂erp库存和wms库存的差别，以及两者的联系：erp是我们库存组维护的库存，wms是下游维护的，他们之间是通过出管系统产生联系。当DTC有采购入库、采购退货、内配等，会下传到wms，wms回传信息给出管系统，之后通过stockchange系统来改变库存。当erp和wms出现库存差异并且是我们库存不准确时，可以手动修数据。
1.2	四种预售类型（采销预售（1），全国EDI预售（2），J仓预售（3），VMI预售（4））；VMI预售虽然物权属于商家，但商品在我们仓库内，因其同仓采购时效快，VMI预售可当作现货（下单状态显示为现货）；站点预售算VMI预售，四个系统通过调stock-bk来设置站点预售（logcloud-wms-service，omnic-ofd-service, tianji,wj-wms-biz）。
1.3	了解FBP（Fulfilled By POP，使用京东销售、仓储、配送；京东开具发票。 FBP模式是京东平台与商家合作的业务模式之一，由商家负责提供商品信息上传、咨询答复、商品推广宣传等事宜。用户下单成功后，“京东”根据双方签订的协议提供仓储及配送等供应链管理服务，并由“京东”给消费者开具商品发票。商家需要重新开一家店铺，**店铺里所有产品必须全部入7地仓**。京东负责存储、打包、发货、物流，发票。商家负责前台店铺维护和销售。其中售后商家可自主来做，也可京东做。）、FCS（Fulfilment Charged Sales，自营模式，和供应商的深度合作)，SCF（在业态上定位为自营业态，前端展示层面展示京东自营标，但从系统实现层面使用了SHOP端等POP能力，与FCS有相似之处）。

商家类型   
   + 自营：自营即供货商模式，是供货商提供商品给京东，京东承担所有服务。 
   + POP：POP模式是京东商城为第三方商家提供交易平台，商家自主承担所有服务，SOP、LBP、FBP、FCS为POP中的一种合作模式。
     + ①SOP(Sale On pop)：SOP模式是商家在京东平台的经营模式之一，由商家以其自身名义进行商品信息上传、展示、咨询答复、商品销售、发票开具、物流配送服务及售后服务提供等。
     + ②LBP(Logistics By POP)：卖家在京东销售商品，卖家每日将消费者订单打包送京东分拣中心，京东完成购物订单配送和收款，京东开具发票给消费者。
     + ③FBP(Fulfillment By POP)：是京东平台与商家合作的业务模式之一，由商家负责提供商品信息上传、咨询答复、商品推广宣传等事宜。用户下单成功后，“京东”根据双方签订的协议提供仓储及配送等供应链管理服务，并由“京东”给消费者开具商品发票。
     + ④FCS(Fulfilment Charged Sales)：是一种新的自营模式，在保持原FBP生产业务流程不变的前提下，通过现有系统改造，结合品牌商合同换签及相关条款约定，以达到京东可全额将订单款计收入的全新模式。商家通过京东开放的仓，配，客，售，更灵活的方式，管理自有供应链，达到京东和商家的双赢。通俗地说，就是商家后端和POP一样操作，前台和自营一样显示，京东全额计收入，店铺业绩记POP。



11.27
a)	VMI预售一般是指：商品在京东库房但是物权不属于京东。用户下单后，ECLP系统触发BIP系统生成采购单，采购入库后为用户发货。若定位仓的现货+vmi满足下单数量，则预占成功。
b)	开放仓一般不会配置覆盖范围，而是通过平行库存支援，当作异地仓定位。平行库存在998配置中配置。针对某一个地址配置的覆盖仓就叫这个地址下的本地仓列表，本地仓的概念是在1号配置（1902-1909配置）中配置了覆盖范围。异地仓是不覆盖这个下单地址，而是通过平行库存追加的。
c)	在预占订单后，因eclp系统可以修改库存，可能导致出现负可用库存，要通过流水查询，找到负可用库存的原因。pop商家的可用库存为负，很大可能是下单之后 eclp同步库存导致； 自营可用库存未负，最可能是开预售。

12.04
1.1	子单预占不校验库存。子单（由OFW拆分）通过pipeline调stockchange进行子单预占。父单下单时，已预占扣减库存。当子单预占扣减库存结束后，父单释放库存（设置延时，防止父单先释放）。
1.2	未付款预占是ofc需要的逻辑（也叫做付款前订单预占）。订单预占的数量是包括未付款预占的，如果出现未付款预占>订单预占，首先排查数据一致性。

12.11
1.1	Mark=32使用京配。有京配标不能使用商家仓发货，但没有京配标，仍可以使用京仓发货。一般配置的优先级：京仓（11开头）>云仓（8开头的9位数）>商家仓（0）。
1.2	切断支援关系后，即使支援配送中心覆盖下单地址，该地址也无法匹配到该仓。使用组件匹配工具，可以很方便地查看某地址下定位到的仓信息。

12.18
1.1	订单能否下传至生产，取决于可用现货，其计算公式为：可用现货= 现货数量-不可售数量-申请单预占-内配出-转移预占-付款前下单预占。

12.25
1.1	申请单锁定出现负数的原因：锁定仓和解锁仓不一致，需要手动修复。
1.2	Pop商品出现数据差异时，不能随意调整，需要查明差异原因。例如，当出现历史订单预占的情况，流水已过期删除，需要订单中间件运维来确认当前订单状态，让IT组来取消或者下传订单。
1.3	Pop生鲜商品（goodstype=1），是否有货，不仅要有仓覆盖，还有满足生鲜路由条件。storeproperty=0-7表示生鲜的8种温层，从0到7，ystype=1或3表示可以用陆运和航运，其他为陆运。查询路由条件的步骤：在kucun.jd.com页面左侧【仓网管理】-【路由管理】查询仓+温层(未设置=0，控温=1…顺序到7)+下单二级地址+陆运/航运查询仓id是否有路由信息，没有则此仓不可用。

12.31
1.1	商品属性发生转换，e.g. 从pop分区商品变为自营商品。转换后，商家需要同步自营商品库存，而不是pop分区商品库存。即使同步pop分区库存成功，erp库存也不改变。

1732： 被支援---支援关系

2021.1.7
1. 事件单处理
   1. 配货出为负的原因：1.没有配货计划，直接配货出库 2.有配货计划，但在配货出库后，取消配货计划。
   2. 全球购商品在港澳台无货，组件匹配返回结果为入参地址为黑名单地区。预占的黑名单过滤条件：命中黑名单地区 && 非本地购商品 && 非全球购商品 && 非自营全球购商品(qqg!=3)。其中isGlobalSale中，如果是港澳商品，还要检查是否是港澳售商品(gas标记右数第一位为1 代表可以售往港澳)。

2. 数据库数据清理技改，自测完成，待代码评审后提测。
3. paas化相关学习
   1. 通过cf中的消费金融paas化实践相关文档，了解领域驱动设计模式下的落地过程。
   2. Matrix官方说明文档，尝试理解框架运行原理。
   3. 结合代码，阅读、理解库存中台paas功能设计说明书。

1.15周报

1.1	水平包中的扩展点实现是我们根据业务积累下来的资产，可以供多个业务身份使用。领域服务的入参可以考虑定义为low level的对象，定义一个adaptor提供对象转换的功能

5	工单值班、事件单处理：
5.1	某订单下单时定位到的仓，并未按照仓优先级定位。经丰哥指导后发现，是命中了最小仓算法，存货比导致。同一个配送中心下，选仓规则是走最小包裹数和最小仓算法：最小包裹优先>阈值清仓(优先小的)>偏离度最小(存货比)。


CAN_USE_NUM = "a";
NP_ZT = "b";
TC_ZT = "c";
TRANS_IN = "d";
J_RESERVE = "e";
CX_RESERVE = "f";
EDI_RESERVE = "g";
VMI_RESERVE = "h";
SUPPORT_IN = "i";
SUPPORT_OUT = "j";
ORDER_BOOKING = "k";
TRANS_BOOKING = "l";
NO_SALE = "m";
APP_BOOKING = "n";
IN_STOCK = "o"
TRANS_OUT = "p";
RETAIN_NUM = "q";
LQ_NUM = "r";
INNER_TRANSFER = "s";
WFK_BOOKING = "t";
CX_LOCK_NUM = "u";
/**采销剩货不可售-剩余可卖数量*/
CX_REMAIN_NUM = "v";
ARRIVE_NUM = "w";
DEDUCT_IN_VM_NUM = "x";


SN_数据项：a:可用库存(含在途库存);  b:在途;  c:现货库存;  d:内部申请单预占;   e:订单预订预占;  f:订单转移预占;  g:内配转移出;  h:内配转移进;  i:计划采购;  j:预售库存;   k:不可销售库存;  m:内部预占;  n:渠道现货库存;  p:渠道订单预订;  q:未付款预订;  r:采销锁定;   s:临期库存;  t:TC在途;  u:预售类型;  v:留框库存;  w:采销锁定类型;   x:采销锁定-补货不可售-剩余可卖数量;  y:采销锁定-时间锁-起始时间;   z:采销锁定-时间锁-结束时间;  A:活动总可用库存数量;  B:锁定业务的发生时间;
SA_数据项：a:可用活动库存;  b:活动总锁定库存;  c:活动开始时间;  d:活动结束时间;  e:有效无效

(1)SW_skuId :商品库房属性 (自营主集群)  (2)SR_{skuId} :预售 (自营主集群)  (3)SN_{skuId} :自营库存数量  (4)SNP_{skuId} :pop库存数量  (5)N_{skuId} :pop分区数量(pop集群)  (6)ST_{skuId}_siteId :站点数量 (pop集群)  (7)SP_skuId :商品属性 (商品集群[已经废弃])  (8)SV_{skuId} :影分身库存限制 (自营主集群)  (9)SLS_skuId :大件关闭库存共享 (自营主集群)  (10)VE_skuId :pop分区覆盖关系 (pop集群)  (11)OR2_skuId :预占结果出参 (自营主集群)  (12)STI_四级地址：天宫站点信息(pop集群)  (13)Y_{子skuId}_父skuId：一盘货限制信息(自营集群)  (14)PST_{skuId}_siteId_venderSource：pop站点数量(pop集群)  (15)SBW_skuId：toB业务sku地址白名单(主集群)  (16)DP_仓类型_源省ID_目的省ID：配送费用   (17)DSS_skuId_dcId：直送SKU   (18)TRA_nationId_lastAreaId：京仓路由信息(nationId:主站4744)(主集群)  (19)CNEL_{skuId}：渠道失效时间信息 (20)STID_{skuId}：自营站点列表信息  (21)SPT_skuId：sku维度大件平行库存共享配置 



1.22 周报
1. 印尼多店铺开发完成。改动点：更改根据col_type判断skuType的方式。
2. 数据清理技改已提测，预计下周二完成测试。
3. 参与k2设计评审，理解期货库存的概念以及我们系统对应的改动点，学习在高并发场景下的设计难点。面对一个新需求，
   1. 判断对以后系统的改动点
   2. 并发场景下，设计会很不一样。
      1. 单一数据项在redis和db的增量更改：redis增量的原子命令+状态机回调确保db操作一定成功。


如何保证redis数据和数据库数据一致。




1.29

1. k2工业品inner接口开发: 
   1. 通过skuId+sid+交期 批量查询期货数量接口 100%
   2. 通过skuId查询期货数量fromDB接口 100%


2. 参加现货库存管理代码、DB/Redis-差异对比inner代码评审


3. 梳理stockadmin中pop商品的库存调整和查询预占订单明细，两处使用整体思路一致
   1. 调inner接口查询skuInfo（根据skuId从guava中查询商品属性，如果guava中不存在，则调用商品组rpc服务里面查询，并回写guava）。
   2. 根据skuId批量查询订单号，查询的是sku->orderId的映射表(异构数据，查询快，但数据有延迟)。
   3. 遍历orderId，在订单中间件，根据orderId查询订单明细（PO对象）。
   4. 解析PO对象，过滤得到有效的OrderInfoVO对象列表。
   5. 在我们订单明细表中，通过orderId获取订单明细对象StockOrder集合。
   6. 在skuId相同的前提下，对比StockOrder对象和OrderInfoVO对象，判断是否有差异。

4. 数据清理worker预发布
   1. 遇到的问题：发现第一个获取最大失效id接口的性能很差，最长可达10s。sql语句：select id from operatecode_pop_0 where created < 给定时间 order by id desc limit 1,并且给定时间久远，sql性能越差。“2020-10-10” 查询只需要400ms，“2017-10-10”需要8s。初步定位原因是created没有索引导致。
   2. 解决方案：设置一个步长step，每轮查询找到< step的最大id及其时间(sql: select id,created from table where id <= step order by id desc limit 1), worker判断created < remainday,批量删除小于该id的数据，步长迭代为step*round。直到查询接口返回created>=remainday时，跳出循环。 


2.5
1. 工单值班
附件 10026226051116和10026225998241 都 未打超级平行库存标，无法匹配到开放仓，固无货。 nsku==5 超级平行库存

1. 数据清理worker完成提测，预计本周日上线。在本次技改开发测试过程中积累的很多数据库的知识点。其中之一就是mysql的覆盖索引和回表相关的。
   1. 例如，我们想找pop防重表中的最小id（字段有：id（主键），rf_operate_code (二级索引), created），可能会写 “select id from operatecode_pop_0 limit 1”，但发现返回的id并不是表中最小的。造成此结果的原因是，mysql并没有使用主键索引进行查找，explain发现使用的key是rf_operate_code。因为mysql的主键是聚簇索引，二级索引是非聚簇索引，rf_operate_code叶子节点中存放的是rf_operate_code本身和主键id。而我们只select id，id在二级索引树中有（覆盖索引），不需要在遍历主键的索引树（不需回表）。所以，这时我们拿到的id，是rf_operate_code索引树中的第一叶子节点的id，并不一定是最小的。“select id， rf_operate_code from operatecode_pop_0 limit 1”同理，用到覆盖索引，不需要回表。当select * || select id, created时，没有覆盖索引，需要回表，limit 1找到的id就是最小的。最后开发中使用的是 “select id from operatecode_pop_0 order by id limit 1”。

2. 印尼多店铺完成提测，预计年后第一个上线日支持上线。

